#!/bin/bash
#
# Rootfs mktree backend for use in throwaway build containers.
#
# Installs RPM into the root filesystem and runs the test-suite against it.
# PWD must be host-mounted for OverlayFS mounts to work.
#
# The root filesystem must be read-only and will be remounted as such otherwise
# before rpmtests is executed.  This is needed because lowerdir is not allowed
# to change when part of an OverlayFS (which rpmtests creates).

source ./mktree.common

CMD=$1; shift
case $CMD in
    build)
        make_install /
    ;;
    check)
        # Get root's current rw/ro mode
        MODE=$(findmnt -n -o OPTIONS / | cut -d, -f1)

        # Remount root as read-only if not already, exit if that fails
        if [ "$MODE" == "rw" ]; then
            mount -o remount,ro / || exit
        fi

        rpmtests "$@"; RC=$?

        # Revert root back to read/write if that was the original mode
        if [ "$MODE" == "rw" ]; then
            mount -o remount,rw / || exit
        fi

        exit $RC
    ;;
    *)
        echo "Unsupported command." >&2
        exit 1
    ;;
esac
