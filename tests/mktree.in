#!/bin/bash

IMAGE=rpm
TARGET=test
SANDBOX=rpm-sandbox
CMD=$1
shift

function create()
{
    if ! podman container exists $SANDBOX; then
        podman create --name $SANDBOX $IMAGE >/dev/null
    fi
}

case $CMD in
    # EXTERNAL
    build)
        podman rmi $IMAGE
        podman build -t $IMAGE --target $TARGET \
                     -f @CMAKE_CURRENT_SOURCE_DIR@/Dockerfile \
                     @CMAKE_SOURCE_DIR@
        name=$(podman create $IMAGE)
        podman unshare $0 _build $name
        podman commit $name $IMAGE
        podman stop $name
        podman rm $name
    ;;
    run)
        podman run --privileged --read-only -it --rm \
                   -v $PWD:$PWD --workdir $PWD $IMAGE "$@"
    ;;
    env)
        create
        podman unshare $0 _env
    ;;
    rm)
        podman stop $SANDBOX
        podman rm $SANDBOX
    ;;

    # INTERNAL
    _build)
        destdir=$(podman mount $1)
        @CMAKE_MAKE_PROGRAM@ -C @CMAKE_BINARY_DIR@ install DESTDIR=$destdir
        ldconfig -r $destdir @CMAKE_INSTALL_FULL_LIBDIR@
        cp -r @CMAKE_CURRENT_SOURCE_DIR@/data $destdir/
        cp -r @TESTPROGS_STR@ $destdir/usr/bin/
        mkdir $destdir/build
        ln -sf /data/SOURCES $destdir/build/
    ;;
    _env)
        set -a
        RPMTEST=$(podman mount $SANDBOX)
        source ./atlocal
        $SHELL
    ;;
esac
