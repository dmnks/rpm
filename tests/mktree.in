#!/bin/bash

PROGRAM=$(basename $0)
OS_BASE=./$PROGRAM.@OS_NAME@

cmd=$1
shift
case $cmd in
    build)
        case $1 in
            base)
                @UNSHARE_CMD@ rm -rf @BASE_DIR@
                ( source $OS_BASE build &&
                  [ -f ./$PROGRAM.extra ] &&
                  source ./$PROGRAM.extra;
                  true )
            ;;
            inst)
                rm -rf @INST_DIR@
                @CMAKE_MAKE_PROGRAM@ -C @CMAKE_BINARY_DIR@ \
                    DESTDIR=@CMAKE_CURRENT_BINARY_DIR@/@INST_DIR@ install
                mkdir -p @PROFILE_DIR@ @LD_CONF_DIR@
                echo "export PATH=@CMAKE_INSTALL_FULL_BINDIR@:/usr/bin" \
                    > @PROFILE_DIR@/rpm.sh
                echo @CMAKE_INSTALL_FULL_LIBDIR@ \
                    > @LD_CONF_DIR@/rpm.conf
                ldconfig -r @INST_DIR@ @CMAKE_INSTALL_FULL_LIBDIR@
            ;;
            util)
                rm -rf @UTIL_DIR@
                mkdir -p @UTIL_DIR@/data
                cp -r @CMAKE_CURRENT_SOURCE_DIR@/data @UTIL_DIR@/
                mkdir -p @UTIL_DIR@/usr/bin
                cp @TESTPROGS_STR@ @UTIL_DIR@/usr/bin/
                mkdir -p @UTIL_DIR@/build
                ln -sf /data/SOURCES @UTIL_DIR@/build/
            ;;
            "")
                $0 $cmd base
                $0 $cmd inst
                $0 $cmd util
            ;;
        esac
    ;;
    install)
        $OS_BASE install "$@"
    ;;
    remove)
        $OS_BASE remove "$@"
    ;;
    run)
        set -a
        source ./atlocal
        source $OS_BASE env
        RPMTEST=$PWD/@SANDBOX_DIR@/merged
        sandbox mount @SANDBOX_DIR@
        $@
        sandbox umount
    ;;
    shell)
        @UNSHARE_CMD@ ./$PROGRAM run sandbox shell "$@"
    ;;
    env)
        @UNSHARE_CMD@ ./$PROGRAM run $SHELL
    ;;
esac
