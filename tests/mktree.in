#!/bin/bash

OS_BASE=$0.@OS_NAME@
CMD=$1
shift

case $CMD in
    build)
        case $1 in
            base)
                $OS_BASE clean
                ( source $OS_BASE build &&
                  [ -f $0.extra ] &&
                  source $0.extra;
                  true )
            ;;
            inst)
                rm -rf @INST_DIR@
                @CMAKE_MAKE_PROGRAM@ -C @CMAKE_BINARY_DIR@ \
                    DESTDIR=@CMAKE_CURRENT_BINARY_DIR@/@INST_DIR@ install
                mkdir -p @PROFILE_DIR@ @LD_CONF_DIR@
                echo "export PATH=@CMAKE_INSTALL_FULL_BINDIR@:/usr/bin" \
                    > @PROFILE_DIR@/rpm.sh
                echo @CMAKE_INSTALL_FULL_LIBDIR@ \
                    > @LD_CONF_DIR@/rpm.conf
                ldconfig -r @INST_DIR@ @CMAKE_INSTALL_FULL_LIBDIR@
            ;;
            util)
                rm -rf @UTIL_DIR@
                mkdir -p @UTIL_DIR@
                cp -r @CMAKE_CURRENT_SOURCE_DIR@/data @UTIL_DIR@/
                mkdir -p @UTIL_DIR@/usr/bin
                cp @TESTPROGS_STR@ @UTIL_DIR@/usr/bin/
                mkdir -p @UTIL_DIR@/build
                ln -sf /data/SOURCES @UTIL_DIR@/build/
            ;;
            "")
                $0 $CMD base
                $0 $CMD inst
                $0 $CMD util
            ;;
        esac
    ;;
    reset)
        @UNSHARE_CMD@ rm -rf @SANDBOX_DIR@
    ;;
    run)
        set -a
        source ./atlocal
        source $OS_BASE env
        RPMTEST=$PWD/@SANDBOX_DIR@/merged
        sandbox mount @SANDBOX_DIR@
        $@
        sandbox umount
    ;;
    shell)
        @UNSHARE_CMD@ $0 run sandbox shell "$@"
    ;;
    env)
        @UNSHARE_CMD@ $0 run $SHELL
    ;;
esac
