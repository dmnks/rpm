#!/bin/bash

IMAGE=rpm
SANDBOX=rpm-sandbox
CMD=$1
shift

case $CMD in
    build)
        podman build -t $IMAGE:base \
                     -f @CMAKE_CURRENT_SOURCE_DIR@/Dockerfile \
                     @CMAKE_SOURCE_DIR@
        name=$(podman create $IMAGE:base)
        podman unshare $0 _build $name
        podman rmi $IMAGE
        podman commit $name $IMAGE
        podman stop $name
        podman rm $name
    ;;
    run)
        podman run --privileged -it --rm \
                   -v $PWD:$PWD --workdir $PWD $IMAGE "$@"
    ;;
    env)
        if ! podman container exists $SANDBOX; then
            podman create --name $SANDBOX $IMAGE >/dev/null
        fi
        podman unshare $0 _env
    ;;
    _build)
        destdir=$(podman mount $1)
        @CMAKE_MAKE_PROGRAM@ -C @CMAKE_BINARY_DIR@ install DESTDIR=$destdir
        ldconfig -r $destdir @CMAKE_INSTALL_FULL_LIBDIR@
        mkdir -p $destdir/usr/local/var/lib/
        rm -rf $destdir/usr/local/var/lib/rpm
        ln -sf /var/lib/rpm $destdir/usr/local/var/lib/rpm
        cp -r @CMAKE_CURRENT_SOURCE_DIR@/data $destdir/
        cp -r @TESTPROGS_STR@ $destdir/usr/bin/
        mkdir $destdir/build
        ln -sf /data/SOURCES $destdir/build/
    ;;
    _env)
        set -a
        RPMTEST=$(podman mount $SANDBOX)
        source ./atlocal
        $SHELL
    ;;
esac
