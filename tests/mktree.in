#!/bin/sh

OS_BUILD=./mktree.@OS_NAME@

TREE_DIR=$PWD/mktree.output
BASE_DIR=$TREE_DIR/base
INST_DIR=$TREE_DIR/inst

SHELL_DIR=$PWD/mktree.shell
CHECK_DIR=$PWD/mktree.check

CMD=$1; shift

# Build and install RPM and the test-suite data into the given directory
function install()
{
    export DESTDIR=$1
    local ld_conf_dir=$DESTDIR/@CMAKE_INSTALL_SYSCONFDIR@/ld.so.conf.d

    @CMAKE_MAKE_PROGRAM@ -C @CMAKE_BINARY_DIR@ install
    mkdir -p $ld_conf_dir
    echo @CMAKE_INSTALL_FULL_LIBDIR@ > $ld_conf_dir/rpm.conf
    ldconfig -r $DESTDIR @CMAKE_INSTALL_FULL_LIBDIR@

    cp -r @CMAKE_CURRENT_SOURCE_DIR@/data $DESTDIR/

    mkdir -p $DESTDIR/usr/bin
    cp @TESTPROG_NAMES@ $DESTDIR/usr/bin/

    mkdir -p $DESTDIR/build
    ln -sf ../data/SOURCES $DESTDIR/build/
}

# Run the given command with the given sandbox mounted at RPMTEST
function wrap()
{
    set -a
    source ./atlocal
    RPMTREE=$INST_DIR:$BASE_DIR
    RPMTEST=$1/tree
    sandbox mount $1
    shift
    "$@"
    sandbox umount $RPMTEST
}

# Run CMD in a user namespace (if not root already)
if [ $(id -u) != 0 ]; then
    if [ -f /run/.toolboxenv ]; then
        # toolbox(1) support
        UNSHARE="sudo --preserve-env"
    else
        UNSHARE="@UNSHARE@ -r --mount --map-auto"
    fi
    $UNSHARE $0 $CMD "$@"
    exit
fi

case $CMD in
    build)
        [ -d "$BASE_DIR" ] ||
        $OS_BUILD $BASE_DIR
        rm -rf $INST_DIR
        install $INST_DIR
    ;;
    shell)
        wrap $SHELL_DIR sandbox shell "$@"
    ;;
    check)
        rm -rf $CHECK_DIR
        wrap $CHECK_DIR sandbox shell --chdir /srv ./rpmtests "$@"
    ;;
    env)
        wrap $CHECK_DIR $SHELL
    ;;
    reset)
        rm -rf $SHELL_DIR
    ;;
    clean)
        rm -rf $BASE_DIR
    ;;
esac
