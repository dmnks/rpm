# vi:filetype=sh

BASE_DIR="${PWD}/@UTIL_DIR@:${PWD}/@INST_DIR@:${PWD}/@TREE_DIR@"
DATA_DIR="${PWD}/@DATA_DIR@"
RPM_CONFIGDIR="@RPMCONFIGDIR@"
LIBDIR="@CMAKE_INSTALL_FULL_LIBDIR@"
RPM_XFAIL=${RPM_XFAIL-1}
DBFORMAT=$(awk '/^%_db_backend/{print $2}' "@INST_DIR@/@RPMCONFIGDIR@/macros")
TZ=UTC

export DBFORMAT TZ
unset SOURCE_DATE_EPOCH

CRYPTO=@CRYPTO@
if test x$CRYPTO = xlibgcrypt
then
    PGP=internal
elif test x$CRYPTO = xopenssl
then
    PGP=internal
elif test x$CRYPTO = xsequoia
then
    PGP=sequoia
else
    echo "Unhandled crypto backend: $CRYPTO"
    exit
fi

if test -x "@__FIND_DEBUGINFO@"; then
    DEBUGINFO_DISABLED=false;
else
    DEBUGINFO_DISABLED=true;
fi

# FIXME
#if [ "@WITH_CAP@" == "ON" ]; then
#    CAP_DISABLED=false;
#else
    CAP_DISABLED=true;
#fi

MALLOC_DEBUG=libc_malloc_debug.so.0
if ! LD_PRELOAD=${MALLOC_DEBUG} /bin/true 2>&1 | grep -q ERROR; then
    MALLOC_PERTURB="$(awk 'BEGIN{srand(); printf "%d\n",(rand()*255)}')"
    LD_PRELOAD="${MALLOC_DEBUG}"
    GLIBC_TUNABLES="glibc.malloc.check=1:glibc.malloc.perturb=${MALLOC_PERTURB}"
    export LD_PRELOAD GLIBC_TUNABLES
fi

# Unmount any leftover trees from previous runs (e.g. failed tests)
for mnt in rpmtests.dir/*/tree; do
    mountpoint -q ${mnt} && umount -l ${mnt}
done

function _overlay()
{
    mkdir temp work tree
    mount -t overlay overlay -o userxattr \
          -o lowerdir=${BASE_DIR},upperdir=temp,workdir=work tree
}

function _bwrap()
{
    bwrap --unshare-pid --dev-bind ${RPMTEST} / \
          --dev /dev --proc /proc --chdir / "$@"
}

function runroot()
{
    _bwrap "$@" --noplugins --nouserns
}

function runroot_other()
{
    _bwrap "$@"
}

function rundebug()
{
    cp ${DATA_DIR}/macros.debug tree/@MACRO_DIR@/
    runroot "$@"
    rm -f tree/@MACRO_DIR@/macros.debug
}
