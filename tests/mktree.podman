#!/bin/bash
#
# Podman-based mktree backend using an OCI image to build and run RPM.
# Works standalone (outside of a build directory) too.

PROGRAM=$(basename $0)
if [ "$PROGRAM" == "mktree" ]; then
    # Running from build directory
    CMAKE=yes
    PODMAN=@PODMAN@
    CONTEXT=@CMAKE_SOURCE_DIR@
else
    # Running from source directory
    CMAKE=no
    PODMAN=$(echo $PROGRAM | cut -d'.' -f2)
    CONTEXT=..
fi

IMAGE=rpm
ARGS="-f Dockerfile $CONTEXT"
ROOTLESS=$([ $(id -u) == 0 ] && echo 0 || echo 1)

rpmtests()
{
    local opts
    local vol="$PWD:/srv:z"

    # Pass select options to $PODMAN
    case "$1" in
        # Useful for CI environments without a tty
        --interactive=*) opts=$1; shift ;;
    esac

    # Don't keep the test artifacts around in non-cmake mode
    if [ $CMAKE == no ]; then
        set -- --log "$@"
        vol=/srv
    fi

    $PODMAN run --privileged -it --rm --read-only --tmpfs /tmp -v $vol \
                --workdir /srv -e ROOTLESS=$ROOTLESS $opts $IMAGE rpmtests "$@"
}

CMD=$1; shift
case $CMD in
    build)
        # Build base image
        $PODMAN build --target base -t $IMAGE/base $ARGS

        # Add RPM install on top
        [ -n "$($PODMAN images -q $IMAGE)" ] && $PODMAN rmi $IMAGE
        $PODMAN build --target full -t $IMAGE $ARGS
    ;;
    check)
        rpmtests "$@"
    ;;
    atshell)
        rpmtests --shell
    ;;
    shell)
        rpmtests --shell snapshot shell
    ;;
    reset)
        rpmtests --reset
    ;;
esac
