#!/bin/bash
#
# Podman mktree backend
#
# Base: OCI image (stable Fedora)
# RPM build: isolated
# Isolation of rpmtests: podman
# Optimized for: portability (CI)
# Works without cmake: yes
# Notes:
#   - invoke via mktree.docker symlink to use docker instead

PROGRAM=$(basename $0)
if [ "$PROGRAM" == "mktree" ]; then
    # Running from build directory
    PODMAN=@PODMAN@
    CONTEXT=@CMAKE_SOURCE_DIR@
else
    # Running from source directory
    PODMAN=$(echo $PROGRAM | cut -d'.' -f2)
    CONTEXT=..
fi

IMAGE=rpm
ROOTLESS=$([ $(id -u) == 0 ] && echo 0 || echo 1)

CMD=$1; shift
case $CMD in
    build)
        cd $(dirname $0)
        $PODMAN build -t $IMAGE -f Dockerfile $CONTEXT
    ;;
    check)
        # Pass select options to $PODMAN
        case "$1" in
            # Useful for CI environments without a tty
            --interactive=*) OPTS=$1; shift ;;
            *) OPTS= ;;
        esac
        $PODMAN run --privileged -it --rm --read-only --tmpfs /tmp \
                    -v /srv --workdir /srv -e ROOTLESS=$ROOTLESS \
                    --env RPMTREE=/ $OPTS $IMAGE rpmtests --log "$@"
    ;;
    *)
        echo "Unsupported command." >&2
        exit 1
    ;;
esac
