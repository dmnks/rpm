#!/bin/bash

LOWERDIR=$PWD/@UTIL_DIR@:$PWD/@INST_DIR@:$PWD/@BASE_DIR@

function sandbox()
{
    case $1 in
        mount) shift
            mkdir -p $1/{upper,work} $RPMTEST
            mount -t overlay ${2:-sandbox} \
                  -o userxattr \
                  -o lowerdir=$LOWERDIR \
                  -o upperdir=$1/upper \
                  -o workdir=$1/work \
                  $RPMTEST
        ;;
        umount)
            umount -l $RPMTEST
        ;;
        prune) shift
            for dir in "$@"; do
                [ -d $dir ] && umount -ql $dir
            done
            return 0
        ;;
        exec) shift
            @BWRAP@ --unshare-pid --dev-bind $RPMTEST / \
                    --dev /dev --proc /proc --chdir / "$@"
        ;;
        shell) shift
            local cmd
            if [ "$1" == "--read-only" ]; then
                mount -o remount,ro $RPMTEST
                shift
            fi
            if [ $# == 0 ]; then
                cmd=$(grep ^root: $RPMTEST/etc/passwd | cut -d: -f7)
            else
                cmd=$1
                shift
            fi
            local hostname=$(findmnt -no SOURCE --mountpoint $RPMTEST)
            sandbox exec --unshare-uts --hostname $hostname \
                         --clearenv --setenv HOME /root \
                         --bind $PWD /srv --chdir /srv $cmd "$@"
        ;;
    esac
}
