#!/bin/bash

cd "$(dirname $0)"
LOWERDIR="${PWD}/@UTIL_DIR@:${PWD}/@INST_DIR@:${PWD}/@TREE_DIR@"

function sandbox()
{
    local cmd=$1
    shift
    case $cmd in
        init)
            mkdir -p upper work merged
            mount -t overlay overlay -o userxattr \
                  -o lowerdir=${LOWERDIR},upperdir=upper,workdir=work merged
        ;;
        rm)
            umount -ql merged
            rm -rf upper work merged
        ;;
        exec)
            @BWRAP@ --unshare-pid --dev-bind $1/merged / \
                    --dev /dev --proc /proc --chdir / \
                    --setenv PATH @CMAKE_INSTALL_PREFIX@/bin:/usr/bin "${@:2}"
        ;;
        create)
            mkdir -p $1
            (cd $1; mountpoint -q merged || sandbox init)
        ;;
        run)
            local ro=0
            if [ "$1" == "--readonly" ]; then
                ro=1
                shift
            fi
            sandbox create $1
            [ $ro == 1 ] && mount -o remount,ro $1/merged
            sandbox exec $1 --bind ${PWD} /srv --chdir /srv "${@:2}"
        ;;
        prune)
            for dir in "$@"; do
                [ -d ${dir} ] && (cd ${dir} && [ -d merged ] && sandbox rm)
            done
        ;;
    esac
}

if [ "$(basename $0)" == "sandbox" ]; then
    @UNSHARE_CMD@ sh -c 'source ./sandbox; sandbox "$@"' "sh" "$@"
fi
