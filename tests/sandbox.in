#!/bin/bash

cd "$(dirname $0)"
LOWERDIR="${PWD}/@UTIL_DIR@:${PWD}/@INST_DIR@:${PWD}/@TREE_DIR@"

function sandbox()
{
    local cmd=$1
    shift
    case $cmd in
        create)
            mkdir -p upper work merged
            mount -t overlay overlay -o userxattr \
                  -o lowerdir=${LOWERDIR},upperdir=upper,workdir=work merged
            export RPMTEST="${PWD}/merged"
        ;;
        rm)
            umount -l merged
            rm -rf upper work merged
        ;;
        exec)
            @BWRAP@ --unshare-pid --dev-bind ${RPMTEST} / \
                    --dev /dev --proc /proc --chdir / \
                    --setenv PATH @CMAKE_INSTALL_PREFIX@/bin:/usr/bin "$@"
        ;;
        run)
            mkdir -p @CONTAINER_DIR@
            cd @CONTAINER_DIR@
            sandbox create
            cd ../..
            sandbox exec --bind ${PWD} /srv --chdir /srv "$@"
        ;;
        prune)
            for mnt in $1/*/merged; do
                mountpoint -q ${mnt} && umount -l ${mnt}
            done
        ;;
    esac
}

if [ "$(basename $0)" == "sandbox" ]; then
    export LOWERDIR
    export -f sandbox
    @UNSHARE_CMD@ sh -c 'sandbox "$@"' $0 "$@"
fi
