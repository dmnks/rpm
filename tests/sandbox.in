#!/bin/bash

DIR=@CMAKE_CURRENT_BINARY_DIR@
LOWERDIR=$DIR/@UTIL_DIR@:$DIR/@INST_DIR@:$DIR/@TREE_DIR@

function sandbox()
{
    local cmd=$1
    shift
    case $cmd in
        init)
            local dir=${1-.}
            mountpoint -q $dir/merged && return
            mkdir -p $dir/{upper,work,merged}
            mount -t overlay overlay -o userxattr \
                  -o lowerdir=$LOWERDIR,upperdir=$dir/upper,workdir=$dir/work \
                  $dir/merged
        ;;
        stop)
            local dir=${1-.}
            mountpoint -q $dir/merged || return
            umount -l $dir/merged
        ;;
        rm)
            local dir=${1-.}
            sandbox stop $dir
            rm -rf $dir/{upper,work,merged}
            rmdir $dir
        ;;
        exec)
            @BWRAP@ --unshare-pid --dev-bind $1/merged / \
                    --dev /dev --proc /proc --chdir / \
                    --setenv PATH @CMAKE_INSTALL_PREFIX@/bin:/usr/bin "${@:2}"
        ;;
        run)
            local ro=0
            if [ "$1" == "--read-only" ]; then
                ro=1
                shift
            fi
            sandbox init $1
            [ $ro == 1 ] && mount -o remount,ro $1/merged
            sandbox exec $1 --bind $DIR $DIR --chdir $DIR "${@:2}"
            sandbox stop $1
        ;;
    esac
}

if [ "$(basename $0)" == "sandbox" ]; then
    export DIR LOWERDIR
    export -f sandbox
    if [ $# == 0 ]; then
        @UNSHARE_CMD@ env PS1="(env)# " sh
    else
        @UNSHARE_CMD@ sh -c 'sandbox "$@"' 'sh' "$@"
    fi
fi
