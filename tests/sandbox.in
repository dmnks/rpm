#!/bin/bash

BASE_DIR="${PWD}/@UTIL_DIR@:${PWD}/@INST_DIR@:${PWD}/@TREE_DIR@"

function mkovl()
{
    mkdir -p temp work tree
    mount -t overlay overlay -o userxattr \
          -o lowerdir=${BASE_DIR},upperdir=temp,workdir=work tree
    export RPMTEST="${PWD}/tree"
    export TOPDIR="${RPMTEST}/build"
}

function rmovl()
{
    umount -l tree
    rm -rf temp work tree
}

function spawn()
{
    bwrap --unshare-pid --dev-bind ${RPMTEST} / \
          --dev /dev --proc /proc --chdir / "$@"
}

if [ "$(basename $0)" == "sandbox" ]; then
    mkdir -p shell
    cd shell
    mkovl
    spawn "$@"
fi
