#!/bin/bash

PROGNAME=$(basename $0)
LOWERDIR=$PWD/@UTIL_DIR@:$PWD/@INST_DIR@:$PWD/@TREE_DIR@

function sandbox()
{
    local cmd=$1
    shift
    case $cmd in
        mount)
            mkdir -p $SANDBOX/{upper,work} $RPMTEST
            mount -t overlay overlay -o userxattr \
                  -o lowerdir=$LOWERDIR,upperdir=$SANDBOX/upper,workdir=$SANDBOX/work \
                  $RPMTEST
        ;;
        umount)
            umount -l $RPMTEST
        ;;
        prune)
            for dir in "$@"; do
                umount -ql $dir
            done
        ;;
        exec)
            @BWRAP@ --unshare-pid --dev-bind $RPMTEST / \
                    --dev /dev --proc /proc --chdir / \
                    --setenv PATH @CMAKE_INSTALL_PREFIX@/bin:/usr/bin "$@"
        ;;
        run)
            local ro=0
            if [ "$1" == "--read-only" ]; then
                ro=1
                shift
            fi
            sandbox mount $1 >/dev/null
            [ $ro == 1 ] && mount -o remount,ro $1/merged
            sandbox exec $1 --bind $PWD $PWD --chdir $PWD "${@:2}"
            sandbox umount $1
        ;;
        shell)
            sandbox run $1 env PS1="(shell)# " sh
        ;;
    esac
}

export LOWERDIR
export -f sandbox

case $PROGNAME in
    rpmtests)
        # No need to scan the mount table (possibly faster)
        MOUNTCHECK="test -d"
    ;;
    sandbox)
        if [ $# == 0 ]; then
            @UNSHARE_CMD@ sh -c 'source '$0'; PS1="(namespace)# " sh'
        else
            @UNSHARE_CMD@ sh -c 'source '$0'; sandbox "$@"' 'sh' "$@"
        fi
    ;;
esac
