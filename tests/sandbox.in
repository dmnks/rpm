#!/bin/bash

LOWERDIR="${PWD}/@UTIL_DIR@:${PWD}/@INST_DIR@:${PWD}/@TREE_DIR@"

function mkovl()
{
    mkdir -p temp work tree
    mount -t overlay overlay -o userxattr \
          -o lowerdir=${LOWERDIR},upperdir=temp,workdir=work tree
    export RPMTEST="${PWD}/tree"
    export TOPDIR="${RPMTEST}/build"
}

function rmovl()
{
    umount -l tree
    rm -rf temp work tree
}

function spawn()
{
    @BWRAP@ --unshare-pid --dev-bind ${RPMTEST} / \
            --dev /dev --proc /proc --chdir / "$@"
}

function shell()
{
    mkdir -p shell
    cd shell
    mkovl
    spawn --bind ${PWD}/.. /srv --chdir /srv "$@"
}

if [ "$(basename $0)" == "sandbox" ]; then
    export LOWERDIR
    export -f mkovl spawn shell
    @UNSHARE_CMD@ sh -c 'shell "$@"' "shell" "$@"
fi
