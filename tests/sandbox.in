#!/bin/bash

PROGRAM=$(basename $0)
SANDBOX=$PWD/@CONTAINER_DIR@
RPMIMAG=$PWD/@UTIL_DIR@:$PWD/@INST_DIR@:$PWD/@TREE_DIR@
RPMTEST=$SANDBOX/merged

function sandbox()
{
    case $1 in
        mount)
            mkdir -p $SANDBOX/{upper,work} $RPMTEST
            mount -t overlay overlay \
                  -o userxattr \
                  -o lowerdir=$RPMIMAG \
                  -o upperdir=$SANDBOX/upper \
                  -o workdir=$SANDBOX/work \
                  $RPMTEST
        ;;
        umount)
            umount -ql $RPMTEST
            return 0
        ;;
        prune) shift
            for dir in "$@"; do
                [ -d $dir ] && umount -ql $dir
            done
            return 0
        ;;
        exec) shift
            @BWRAP@ --unshare-pid --dev-bind $RPMTEST / \
                    --dev /dev --proc /proc --chdir / \
                    --setenv PATH @CMAKE_INSTALL_PREFIX@/bin:/usr/bin "$@"
        ;;
        shell) shift
            local cmd
            if [ $# == 0 ]; then
                cmd=$(grep ^root: $RPMTEST/etc/passwd | cut -d: -f7)
            else
                cmd=$1
                shift
            fi
            sandbox exec --unshare-uts --hostname $(basename $SANDBOX) \
                         --unsetenv PS1 --setenv HOME /root \
                         --bind $PWD /srv --chdir /srv $cmd "$@"
        ;;
    esac
}

case $PROGRAM in
    sandbox)
        @UNSHARE_CMD@ bash -c "source $0" wrap "$@"
        exit 0
    ;;
    wrap)
        sandbox mount
        case $1 in
            "")
                bash -c "set -a; source ./atlocal; $SHELL"
            ;;
            shell) shift
                if [ "$1" == "--read-only" ]; then
                    mount -o remount,ro $RPMTEST
                    shift
                fi
                sandbox shell "$@"
            ;;
        esac
        sandbox umount
    ;;
esac
