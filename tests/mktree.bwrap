#!/bin/bash

source ./mktree.common

OS_BUILD=./mktree.@OS_NAME@
CMD=$1; shift

UNSHARE="/usr/bin/unshare -rm --map-auto"

TREE_DIR=$PWD/mktree.output
BASE_DIR=$TREE_DIR/base
INST_DIR=$TREE_DIR/inst
SBOX_DIR=$PWD/mktree.sandbox

function unshare()
{
    [ -n "$UNSHARED" ] && return
    UNSHARED=1 $UNSHARE $0 $CMD
    exit
}

function run()
{
    set -a
    source ./atlocal
    source $OS_BUILD --env
    RPMTREE=$INST_DIR:$BASE_DIR
    RPMTEST=$SBOX_DIR/merged
    sandbox mount $SBOX_DIR
    "$@"
    sandbox umount $RPMTEST
}

case $CMD in
    build) unshare
        [ -d $BASE_DIR ] && exit
        $OS_BUILD $BASE_DIR
    ;;
    install)
        rm -rf $INST_DIR
        install $INST_DIR
    ;;
    shell) unshare
        run sandbox shell "$@"
    ;;
    env) unshare
        run $SHELL
    ;;
    reset) unshare
        rm -rf $SBOX_DIR
    ;;
    clean) unshare
        rm -rf $BASE_DIR
    ;;
esac
