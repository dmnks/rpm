#!/bin/bash
#
# OCI-based mktree backend

PROGRAM=$(basename $0)
if [ "$PROGRAM" == "mktree" ]; then
    # Running from build directory
    CMAKE=yes
    NATIVE=@MKTREE_NATIVE@
    PODMAN=@PODMAN@
    CONTEXT=@CMAKE_SOURCE_DIR@
else
    # Running from source directory
    CMAKE=no
    NATIVE=no
    PODMAN=${MKTREE_ENGINE:-podman}
    CONTEXT=..
fi

if [ $NATIVE == yes ]; then
    FROM="--from @OS_NAME@:@OS_VERSION@"
else
    FROM=
fi

IMAGE=rpm
ARGS="-f Dockerfile $FROM $CONTEXT"
CMD=$1; shift

if [ $(id -u) != 0 ]; then
    $PODMAN unshare $0 $CMD "$@"
    exit
fi

source mktree.common

rpmtests()
{
    local opts
    local vol="$PWD:/srv"

    # Pass select options to $PODMAN
    case "$1" in
        # Useful for CI environments without a tty
        --interactive=*) opts=$1; shift ;;
    esac

    # Don't keep the test artifacts around in non-cmake mode
    if [ $CMAKE == no ]; then
        set -- --log "$@"
        vol=/srv
    fi

    source ./snapshot
    mkdir -p $PWD/blah-img
    chcon -Rt container_file_t $PWD
    mount --bind $(podman image mount rpm/base) $PWD/blah-img
    RPMTREE=$PWD/blah-rpm:$PWD/blah-img
    RPMTEST=$PWD/blah-mnt
    snapshot mount
    $PODMAN run --privileged -it --read-only --tmpfs /tmp -v $vol \
                --workdir /srv $opts -e RPMTREE=/srv/blah-rpm:/srv/blah-img --rootfs $RPMTEST rpmtests "$@"
    snapshot umount
    umount $PWD/blah-img
    podman image umount rpm/base
}

case $CMD in
    build)
        if [ $NATIVE == yes ]; then
            # Native build
            $PODMAN build --target base -t rpm/base $ARGS
            # chmod -Rf u+rwX $PWD/blah-img
            rm -rf $PWD/blah-rpm
            make_install $PWD/blah-rpm
        else
            # Standalone build
            [ -n "$($PODMAN images -q $IMAGE)" ] && $PODMAN rmi $IMAGE
            $PODMAN build --target full -t $IMAGE $ARGS
        fi
    ;;
    check)
        rpmtests "$@"
    ;;
    atshell)
        rpmtests --shell "$@"
    ;;
    shell)
        rpmtests --shell snapshot shell
    ;;
    reset)
        rpmtests --reset
    ;;
esac
