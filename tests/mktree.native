#!/bin/bash
#
# Fedora-native mktree backend using DNF to bootstrap a minimal OS tree with
# the RPM runtime and test dependencies but no stock RPM preinstalled.
# Lightweight snapshotting built into the test-suite is used for isolation.

if [ $(id -u) != 0 ]; then
    podman unshare $0 "$@"
    exit
fi

source ./mktree.common

IMAGE=rpm

TREE_DIR=$PWD/mktree.output
INST_DIR=$TREE_DIR/inst
SANDBOX_DIR=$PWD/mktree.sandbox

ATSHELL_MOTD="
Welcome to RPM @CMAKE_PROJECT_VERSION@ Autotest shell!

This is like an interactive test with a writable snapshot
mounted at \$RPMTEST, with full host integration allowing
you to use your native tools to inspect and/or modify the
snapshot.

The usual test commands are available, e.g. runroot ...
To throw away the snapshot and start over, run: make reset

WARNING: The shell runs in a user namespace, without file
system isolation, so be cautious when using destructive
commands. Treat it like any other shell running on your
host.
"

mount_tree()
{
    local dir=$SANDBOX_DIR
    if [ "$1" == "--read-only" ]; then
        mkdir -p $INST_DIR/$PWD
        unset dir
    fi
    BASE_DIR=$(podman image mount $IMAGE)
    RPMTREE=$INST_DIR:$BASE_DIR
    RPMTEST=$SANDBOX_DIR/tree
    trap : INT  # Continue on SIGINT
    snapshot mount $dir
}

umount_tree()
{
    podman image umount $IMAGE >/dev/null
    snapshot umount
}

fix_perm()
{
    chmod -Rf u+rwX "$@"
}

CMD=$1; shift
case $CMD in
    build)
        # Build base image
        podman build --target base -t $IMAGE .

        # Build RPM layer natively
        rm -rf "$INST_DIR"
        make_install $INST_DIR

        # Signal change to build system
        touch $TREE_DIR
    ;;
    atshell)
        set -a
        source ./atlocal
        mount_tree
        echo "$ATSHELL_MOTD"
        $SHELL
        umount_tree
        fix_perm $SANDBOX_DIR
    ;;
    shell)
        mount_tree
        snapshot shell "$@"
        umount_tree
        fix_perm $SANDBOX_DIR
    ;;
    check)
        mount_tree --read-only
        snapshot exec --tmpfs /tmp --bind $PWD $PWD --bind $BASE_DIR /mnt \
                      --setenv RPMTREE $INST_DIR:/mnt rpmtests -C $PWD "$@"
        umount_tree
        fix_perm rpmtests.dir
    ;;
    reset)
        rm -rf "$SANDBOX_DIR"
    ;;
esac
