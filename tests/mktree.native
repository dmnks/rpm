#!/bin/bash
# Native mktree backend using lightweight sandboxing from test suite

source ./mktree.common

OS_BUILD=./$PROGRAM.@OS_NAME@
CMD=$1; shift

TREE_DIR=$PWD/$PROGRAM.output
BASE_DIR=$TREE_DIR/base
INST_DIR=$TREE_DIR/inst

CACHE_DIR=$PWD/$PROGRAM.cache
SHELL_DIR=$PWD/$PROGRAM.shell
CHECK_DIR=$PWD/$PROGRAM.check

# Run CMD in user namespace (if not root already)
function unshare()
{
    local cmd
    if [ $(id -u) == 0 ]; then
        return
    elif [ -f /run/.toolboxenv ]; then
        # toolbox(1) support
        cmd="sudo -E"
    else
        cmd="/usr/bin/unshare -rm --map-auto"
    fi
    $cmd $0 $CMD "$@"
    exit
}

# Run given command with sandbox mounted at RPMTEST
function run()
{
    set -a
    source ./atlocal
    source $OS_BUILD --env
    RPMTREE=$INST_DIR:$BASE_DIR
    RPMTEST=$1/merged
    sandbox mount $1
    "$@"
    sandbox umount $RPMTEST
}

case $CMD in
    build) unshare
        [ -d "$BASE_DIR" ] && exit
        $OS_BUILD $BASE_DIR $CACHE_DIR
    ;;
    install)
        rm -rf $INST_DIR
        install $INST_DIR
    ;;
    shell) unshare "$@"
        run $SHELL_DIR sandbox shell "$@"
    ;;
    check) unshare "$@"
        run $CHECK_DIR sandbox shell --read-only ./rpmtests "$@"
        rm -rf $CHECK_DIR
    ;;
    env) unshare
        run $SHELL_DIR $SHELL
    ;;
    reset) unshare
        rm -rf $SHELL_DIR
    ;;
    clean) unshare
        rm -rf $BASE_DIR
    ;;
esac
