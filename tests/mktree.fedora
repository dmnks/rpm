#!/bin/bash

# Bootstrap a minimal filesystem tree with RPM's runtime dependencies that are
# ABI compatible with the build dependencies used.  No existing RPM
# installation should be present in the tree.
#
# Useful CMake variables:
#   TREEDIR: absolute path to the destination directory of the tree
#   LSB_RELEASE: OS version
#   UNSHARE_CMD: runs a program in a user namespace (if not root already)
#
# To support ENABLE_SANDBOX, test-suite dependencies must also be present in
# the tree.
#
# This script must work if executed as a regular user as well as root.

cachedir=$(python3 -c 'import dnf; print(dnf.conf.Conf().cachedir)')

@UNSHARE_CMD@ dnf -y install \
    --installroot=@TREEDIR@ \
    --releasever=@LSB_RELEASE@ \
    --setopt=cachedir=${cachedir} \
    --setopt=keepcache=1 \
    --setopt=install_weak_deps=0 \
    --disablerepo=\* --enablerepo=fedora,updates \
    audit \
    bash \
    binutils \
    bubblewrap \
    bzip2 \
    coreutils \
    cpio \
    curl \
    debugedit \
    diffutils \
    elfutils-libelf \
    elfutils-libs \
    file \
    file-libs \
    findutils \
    gawk \
    gcc \
    gdb-headless \
    gdb-minimal \
    glibc \
    gpg \
    grep \
    gzip \
    ima-evm-utils \
    libacl \
    libarchive \
    libcap \
    libfsverity \
    libgomp \
    libzstd \
    lua-libs \
    make \
    openssl-libs \
    patch \
    pkgconf-pkg-config \
    python3 \
    rpm-sequoia \
    sed \
    sqlite-libs \
    tar \
    unzip \
    util-linux-core \
    xz \
    xz-libs \
    zlib \
    zstd
